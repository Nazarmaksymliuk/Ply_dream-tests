name: E2E Tests & Allure (Kyiv 07:00)

on:
  schedule:
    - cron: "0 4 * 4-10 *"        # 07:00 Kyiv (DST)
    - cron: "0 5 * 11,12,1,2,3 *" # 07:00 Kyiv (standard)
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  test-and-report:
    runs-on: ubuntu-22.04
    env:
      MAVEN_OPTS: -Xmx2g
      PLAYWRIGHT_HEADLESS: "true"
      PLAYWRIGHT_BROWSERS_PATH: "0"
      HEADLESS: "true" # твій Java код читає HEADLESS

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- VPN BLOCK ----------

      - name: Install OpenVPN
        run: |
          sudo apt-get update
          sudo apt-get install -y openvpn curl

      - name: Start VPN (OpenVPN via .ovpn profile)
        env:
          OVPN_PROFILE:  ${{ secrets.OVPN_PROFILE }}
          OVPN_USERNAME: ${{ secrets.OVPN_USERNAME }}
          OVPN_PASSWORD: ${{ secrets.OVPN_PASSWORD }}
        run: |
          printf '%s\n' "$OVPN_PROFILE" > config.ovpn
          printf '%s\n%s\n' "$OVPN_USERNAME" "$OVPN_PASSWORD" > auth.txt
          chmod 600 auth.txt || true

          sudo openvpn --config config.ovpn --auth-user-pass auth.txt > openvpn.log 2>&1 &

          for i in {1..90}; do
            if grep -q "Initialization Sequence Completed" openvpn.log; then
              echo "VPN UP"
              break
            fi
            sleep 1
          done

          echo "===== OpenVPN LOG (FULL) ====="
          cat openvpn.log || true
          echo "================================"

          if ! grep -q "Initialization Sequence Completed" openvpn.log; then
            echo "❌ VPN FAILED — дивись лог вище"
            exit 1
          fi

          echo "Public IP after VPN:"
          curl -s https://ifconfig.me || true
          echo

      # ✅ FIX ROUTES: add route to VPC via tun0
      - name: Add route to VPC (172.31.0.0/16) via tun0
        run: |
          echo "=== ip addr (after VPN) ==="
          ip addr
          echo
          echo "=== ip route (before) ==="
          ip route
          echo
          echo "Adding route 172.31.0.0/16 dev tun0"
          sudo ip route add 172.31.0.0/16 dev tun0 || true
          echo
          echo "=== ip route (after) ==="
          ip route
          echo
          echo "=== route get checks ==="
          ip route get 172.31.85.10 || true
          ip route get 172.31.64.242 || true
          ip route get 172.31.53.203 || true
          ip route get 172.31.19.237 || true

      # ✅ Pick reachable IP on 443 + write /etc/hosts + curl sanity
      - name: Select reachable stage IP and validate connectivity
        run: |
          sudo apt-get update
          sudo apt-get install -y netcat-openbsd

          # очистити старі entries
          sudo sed -i '/stage.getply.com/d' /etc/hosts

          IPS="172.31.85.10 172.31.64.242 172.31.53.203 172.31.19.237"
          FOUND=""

          echo "=== Trying to find reachable stage IP on port 443 ==="
          for ip in $IPS; do
            echo "Testing $ip:443..."
            if nc -vz -w 5 $ip 443; then
              FOUND="$ip"
              break
            fi
          done

          if [ -z "$FOUND" ]; then
            echo "❌ No reachable stage IP on port 443. This is infra/VPN/SG/NACL issue."
            exit 1
          fi

          echo "$FOUND stage.getply.com" | sudo tee -a /etc/hosts

          echo
          echo "=== Hosts entry ==="
          getent hosts stage.getply.com

          echo
          echo "=== Curl sanity (30s max) ==="
          curl -vkL --max-time 30 https://stage.getply.com/ || echo "Curl failed"

      # ---------- JAVA + TESTS ----------

      - name: Set up Java 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Install Playwright system deps & browsers
        run: |
          mvn -B org.codehaus.mojo:exec-maven-plugin:3.5.0:java \
            -Dexec.mainClass=com.microsoft.playwright.CLI \
            -Dexec.args="install --with-deps"

      - name: Run tests
        env:
          PLAYWRIGHT_HEADLESS: "true"
          PLAYWRIGHT_BROWSERS_PATH: "0"
          HEADLESS: "true"
        run: mvn -B clean verify

      # ---------- UPLOAD PLAYWRIGHT ARTIFACTS ----------

      - name: Upload Playwright traces & screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-artifacts
          path: |
            **/build/trace*.zip
            **/build/traces/**/*.zip
            **/build/screenshots/**
            **/build/ui-auth-storage-state.json
            **/build/ui-auth.json
          if-no-files-found: warn
          retention-days: 14

      # ---------- ALLURE ----------

      - name: Generate Allure report
        if: always()
        run: mvn -B allure:report

      - name: Upload Allure report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: target/allure-report

      - name: Upload Allure site
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: allure-site
          path: target/allure-report/**
          if-no-files-found: error
          retention-days: 14

  deploy-allure:
    needs: test-and-report
    if: always()
    runs-on: ubuntu-22.04
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Download Allure site artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-site
          path: ./allure-site

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./allure-site

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
